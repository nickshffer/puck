<html>
<head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=210, initial-scale=1">
</head>
<body style="width:210px;height:450px">
<link href="https://espruino.github.io/TinyDash/tinydash.css" rel="stylesheet">
<script src="https://espruino.github.io/TinyDash/tinydash.js"></script>
<script src="https://www.puck-js.com/puck.js"></script>
<script>
    // Called when we get a line of data - updates the light color
    var createRingBuffer = function (length) {
        /* https://stackoverflow.com/a/4774081 */
        var pointer = 0, buffer = [];

        return {
            data: function () {
                return buffer
            },
            push: function (item) {
                buffer[pointer] = item;
                pointer = (pointer + 1) % length;
                return item;
            }
        };
    };

    var mag_x = createRingBuffer(50);
    var mag_y = createRingBuffer(50);
    var mag_z = createRingBuffer(50);

    function onLine(line) {
        try {
            var j = JSON.parse(line);
            console.log("Received JSON: ", j);
            elements.light.setValue(j.light * 100);
            mag_x.push(j.mag.x);
            mag_y.push(j.mag.y);
            mag_z.push(j.mag.z);
            elements.mag_x.setData(mag_x.data);
            elements.mag_y.setData(mag_y.data);
            elements.mag_z.setData(mag_z.data);
        } catch (e) {
            console.log("Received: ", line);
        }
    }

    var connection;

    function connectDevice() {
        Puck.connect(function (c) {
            if (!c) {
                alert("Couldn't connect!");
                return;
            }
            connection = c;
            // remove modal window
            elements.modal.remove();
            // Handle the data we get back, and call 'onLine'
            // whenever we get a line
            var buf = "";
            connection.on("data", function (d) {
                buf += d;
                var i = buf.indexOf("\n");
                while (i >= 0) {
                    onLine(buf.substr(0, i));
                    buf = buf.substr(i + 1);
                    i = buf.indexOf("\n");
                }
            });
            // First, reset Puck.js
            connection.write("reset();\n", function () {
                // Wait for it to reset itself
                setTimeout(function () {
                    // Now tell it to write data on the current light level to Bluetooth
                    // 10 times a second. Also ensure that when disconnected, Puck.js
                    // resets so the setInterval doesn't keep draining battery.
                    connection.write("setInterval(function(){Bluetooth.println(JSON.stringify({light:Puck.light(),mag:Puck.mag()}));},100);NRF.on('disconnect',function(){Puck.magOn();reset();});\n",
                        function () {
                            console.log("Ready...");
                        });
                }, 1500);
            });
        });

    }

    // Set up the controls we see on the screen
    var elements = {
        heading: TD.label({x: 10, y: 10, width: 190, height: 50, label: "My Dashboard"}),
        light: TD.gauge({x: 10, y: 70, width: 190, height: 220, label: "Light", value: 0, min: 0, max: 100}),
        mag_x: TD.graph({x: 210, y: 10, width: 400, height: 180, label: "Mag X"}),
        mag_y: TD.graph({x: 210, y: 200, width: 400, height: 180, label: "Mag Y"}),
        mag_z: TD.graph({x: 210, y: 390, width: 400, height: 180, label: "Mag Z"}),
        modal: TD.modal({x: 10, y: 10, width: 190, height: 430, label: "Click to connect", onchange: connectDevice})
    }
    for (var i in elements)
        document.body.appendChild(elements[i]);
</script>
</body>
</html>
